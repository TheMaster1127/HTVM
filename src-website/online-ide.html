<!DOCTYPE html>
<html>
<head>
  <title>HTVM IDE</title>
  <link rel="icon" href="img/favicon.webp" type="image/png">
  <style>
    :root {
      --bg-color: #1a1a1a;
      --text-color: #e0e0e0;
      --sidebar-bg: #2d2d2d;
      --hover-bg: #404040;
      --btn-bg: #fe6619;
      --btn-hover: #e65a00;
      --splitter-bg: #555;
    }
    * {
      box-sizing: border-box;
      user-select: none;
    }
    html, body {
      height: 100%;
      margin: 0;
    }
    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: Arial, sans-serif;
      display: flex;
      overflow: hidden;
    }
    /* Sidebar */
    #sidebar {
      width: 250px;
      min-width: 150px;
      background-color: var(--sidebar-bg);
      padding: 10px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    #path-display {
      margin-bottom: 5px;
      font-size: 0.9em;
      color: #ccc;
    }
    #file-path-display {
      margin-bottom: 10px;
      font-size: 0.85em;
      color: #aaa;
    }
    #sidebar-splitter {
      width: 5px;
      background-color: var(--splitter-bg);
      cursor: ew-resize;
    }
    /* Main Content Area */
    #main-content {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    /* IDE Column (Editor & Console) */
    #ide-container {
      display: flex;
      flex-direction: column;
      overflow: hidden;
      width: 80%;
      min-width: 20%;
    }
    #buttons-container {
      padding: 5px;
      background: var(--bg-color);
    }
    /* Editor (top half of IDE) */
    #editor {
      height: 70%;
      border: 1px solid var(--hover-bg);
      overflow: auto;
      display: none;
    }
    /* Horizontal splitter between editor and console */
    #ide-horizontal-splitter {
      height: 5px;
      background-color: var(--splitter-bg);
      cursor: ns-resize;
    }
    /* Console container: flex:1 fills remaining space */
    #console {
      flex: 1;
      position: relative;
      background-color: #000;
      color: #0f0;
      font-family: monospace;
      font-size: 14px;
      padding: 10px;
      overflow: hidden;
    }
    /* Scrollable log area */
    #console-log {
      overflow-y: auto;
      height: 100%;
      padding-right: 40px; /* extra space for clear button */
    }
    /* Clear button fixed at bottom-right */
    #clear-console-btn {
      position: absolute;
      bottom: 5px;
      right: 5px;
      background-color: var(--btn-bg);
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      z-index: 10;
    }
    #clear-console-btn:hover {
      background-color: var(--btn-hover);
    }
    /* Vertical splitter between IDE and Output */
    #vertical-splitter {
      width: 5px;
      background-color: var(--splitter-bg);
      cursor: ew-resize;
      display: none;
    }
    /* Output Column (only visible for HTML files) */
    #output-container {
      width: 80%;
      min-width: 50%;
      display: none;
      flex-direction: column;
      overflow: auto;
      border-left: 1px solid var(--hover-bg);
      padding: 5px;
    }
    /* The HTML output iframe */
    #html-output {
      width: 100%;
      height: 100%;
      border: none;
    }
    #close-iframe-btn {
      background-color: var(--btn-bg);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 5px;
    }
    #close-iframe-btn:hover {
      background-color: var(--btn-hover);
    }
    
    
    /* Toggle Switch CSS */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 25px;
      top: -5px; /* Move the element up by 5 pixels */
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-switch .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 24px;
    }
    
    .toggle-switch .slider:before {
      position: absolute;
      content: "";
      height: 23px;
      width: 23px;
      border-radius: 50%;
      left: 4px;
      bottom: 1px;
      background-color: white;
      transition: 0.4s;
    }
    
    input:checked + .slider {
      background-color: #4CAF50;
    }
    
    input:checked + .slider:before {
      transform: translateX(26px);
    }
    

    /* Sidebar items */
    .item {
      padding: 8px;
      margin: 4px 0;
      display: flex;
      align-items: center;
      border-radius: 4px;
      transition: background-color 0.2s;
    }
    .item:hover {
      background-color: var(--hover-bg);
    }
    .folder::before {
      content: 'üìÅ ';
      margin-right: 5px;
    }
    .file::before {
      content: 'üìÑ ';
      margin-right: 5px;
    }
    .item span.name {
      flex: 1;
      cursor: pointer;
    }
    .item button.action-btn {
      background: transparent;
      border: none;
      color: #aaa;
      cursor: pointer;
      margin-left: 4px;
      font-size: 16px;
    }
    .item button.action-btn:hover {
      color: #fff;
    }
    /* Common button styling */
    button {
      background-color: var(--btn-bg);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px 5px 5px 0;
    }
    button:hover {
      background-color: var(--btn-hover);
    }
    button:disabled {
      background-color: #333;
      cursor: not-allowed;
    }
  </style>
<!-- Load Ace Editor core -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>

<!-- Load the language tools extension -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ext-language_tools.js"></script>

  <!-- HTVM syntax -->  
  <script src="htvm-mode.js"></script>
  <script src="htvm_completions.js"></script>
  <!-- HTVM transpiler in js -->
  <script src="../HTVM.js"></script>
</head>
<body>
  <!-- Sidebar -->
  <div id="sidebar">
    <div id="path-display"></div>
    <div id="file-path-display"></div>
    <button id="back-btn" onclick="goBack()" disabled>‚Üê Back</button>
    <div id="directory-contents"></div>
  </div>
  <div id="sidebar-splitter"></div>
  <!-- Main Content Area -->
  <div id="main-content">
    <!-- IDE Column (Editor & Console) -->
    <div id="ide-container">
      <div id="buttons-container">
        <button onclick="createNew('file')">New File</button>
        <button onclick="createNew('folder')">New Folder</button>
        <button onclick="runFile()" id="run-btn">Run (Ctrl+Enter)</button>
        <button onclick="closeIframe()" id="close-iframe-btn">Close Iframe html</button>
        <label class="toggle-switch">
          <input type="checkbox" id="runJsAfterHTVM">
          <span class="slider"></span>
        </label>
          <span>Run JS after HTVM Conversion</span>
      </div>
      <div id="editor"></div>
      <div id="ide-horizontal-splitter"></div>
      <div id="console">
        <div id="console-log">
          <!-- Log output goes here -->
        </div>
        <button id="clear-console-btn" onclick="clearConsole()">Clear</button>
      </div>
    </div>
    <!-- Vertical Splitter between IDE and Output -->
    <div id="vertical-splitter"></div>
    <!-- Output Column (visible only for HTML files) -->
    <div id="output-container">
      <iframe id="html-output"></iframe>
      <button onclick="closeIframe()" id="close-iframe-btn">Close Output</button>
    </div>
  </div>

  <script>
  
// Check if there's a saved value in localStorage and set the initial state
let runJsAfterHTVM = localStorage.getItem('runJsAfterHTVM') === 'true'; // Retrieve and convert to boolean

//console.log(runJsAfterHTVM)

// Set the checkbox based on the stored value
document.getElementById('runJsAfterHTVM').checked = runJsAfterHTVM;

// Function to handle toggle change
document.getElementById('runJsAfterHTVM').addEventListener('change', function() {
  runJsAfterHTVM = this.checked;
  localStorage.setItem('runJsAfterHTVM', runJsAfterHTVM); // Save the value to localStorage
  console.log("Run JS after HTVM conversion: " + runJsAfterHTVM);
});

  
let build_in_funcs = '';

function fetchBuildInFuncs() {
    // Fetch the HTVM-instructions.txt file from the URL
    fetch('https://raw.githubusercontent.com/TheMaster1127/HTVM/refs/heads/main/HTVM-instructions.txt')
        .then(response => response.text())  // Get the raw text of the file
        .then(data => {
            // Split the text into an array of lines
            const lines = data.split('\n');
            
            // Extract the lines from 163 to the end (index 162 to the end of the array)
            build_in_funcs = lines.slice(162).join('\n');
            
            // You now have the build_in_funcs variable populated with lines from 163 to the end
            //console.log(build_in_funcs);  // Optionally print the result to check
        })
        .catch(error => {
            console.error('Error fetching HTVM-instructions.txt:', error);
        });
}

// Call the function to fetch the data
fetchBuildInFuncs();

  
  
    /* ----------------------------
       Utility & Persistence Setup
    ----------------------------- */
    function getUrlParam(param) {
      let params = new URLSearchParams(window.location.search);
      return params.get(param);
    }
    let uniqueId = getUrlParam('id') || 'default';
    const fileSystemKey = 'fileSystem_' + uniqueId;
    const lastFileKey = 'lastFile_' + uniqueId;
    const defaultStructure = {
      name: 'root',
      isFolder: true,
      children: [
        { name: 'Documents', isFolder: true, children: [] },
        { name: 'README.txt', isFolder: false, content: 'Welcome to the file system simulation!' }
      ]
    };
    function loadFileSystem() {
      const data = localStorage.getItem(fileSystemKey);
      return data ? JSON.parse(data) : defaultStructure;
    }
    let root = loadFileSystem();
    function saveFileSystem() {
      localStorage.setItem(fileSystemKey, JSON.stringify(root));
    }
    function saveLastFile(path) {
      localStorage.setItem(lastFileKey, JSON.stringify(path));
    }
    function loadLastFile() {
      const data = localStorage.getItem(lastFileKey);
      return data ? JSON.parse(data) : null;
    }
    function findPath(node, target, currentPath = []) {
      if (node === target) return currentPath.concat(node.name);
      if (node.isFolder && node.children) {
        for (let child of node.children) {
          let result = findPath(child, target, currentPath.concat(node.name));
          if (result) return result;
        }
      }
      return null;
    }
    function getItemByPath(path, node) {
      if (!path.length) return node;
      if (!node.isFolder || !node.children) return null;
      const nextName = path[0];
      for (let child of node.children) {
        if (child.name === nextName) {
          return getItemByPath(path.slice(1), child);
        }
      }
      return null;
    }

    /* ----------------------------
       System State & Editor Setup
    ----------------------------- */
    let currentDir = root;
    let dirHistory = [];
    let openFile = null; // currently open file
    let editor = ace.edit("editor");
    
    let langTools = ace.require("ace/ext/language_tools");
  
    
    editor.setTheme("ace/theme/monokai");
    editor.session.setMode("ace/mode/javascript");

    editor.setOptions({
        enableBasicAutocompletion: true,    // Enable basic autocompletion
        enableLiveAutocompletion: true,     // Enable live autocompletion
        enableSnippets: false,              // Disable snippets if not needed
        showPrintMargin: false,             // Hide the print margin
        behavioursEnabled: false            // Disable behavior-based completions like indent
    });
    
                langTools.setCompleters([]);
            langTools.addCompleter(Completer);
    editor.setOptions({ fontSize: "18px" });
    editor.on("change", function() {
      if (openFile) {
        openFile.content = editor.getValue();
        saveFileSystem();
        let path = findPath(root, openFile);
        if (path) saveLastFile(path);
        updateFilePathDisplay();
      }
    });

    /* ----------------------------
       File/Folder Operations
    ----------------------------- */
    function createNew(type) {
      const name = prompt(`Enter ${type} name:`);
      if (!name) return;
      if (currentDir.children.some(item => item.name === name)) {
        alert('Name already exists!');
        return;
      }
      let newItem = type === 'file'
        ? { name, isFolder: false, content: '' }
        : { name, isFolder: true, children: [] };
      currentDir.children.push(newItem);
      saveFileSystem();
      renderDirectory();
    }
    function renameItem(item) {
      const newName = prompt("Enter new name:", item.name);
      if (!newName || newName === item.name) return;
      if (currentDir.children.some(child => child.name === newName)) {
        alert('A file or folder with that name already exists!');
        return;
      }
      item.name = newName;
      if (openFile === item) {
        let path = findPath(root, item);
        if (path) saveLastFile(path);
      }
      saveFileSystem();
      renderDirectory();
      updateFilePathDisplay();
    }
    function deleteItem(item) {
      if (!confirm(`Are you sure you want to delete "${item.name}"? This will delete all its contents if it's a folder.`)) {
        return;
      }
      if (openFile === item) {
        openFile = null;
        document.getElementById('editor').style.display = 'none';
        updateFilePathDisplay();
      }
      currentDir.children = currentDir.children.filter(child => child !== item);
      saveFileSystem();
      renderDirectory();
    }


// First, add the fileExtensionToLangName function
function fileExtensionToLangName(extension) {
  // Mapping of file extensions to language names
  const extToLangMap = {
    abap: [".abap"],
    abc: [".abc"],
    actionscript: [".as"],
    ada: [".ada"],
    apache_conf: [".conf"],
    asciidoc: [".adoc", ".asciidoc"],
    assembly_x86: [".asm"],
    autohotkey: [".ahk"],
    batchfile: [".bat"],
    c9search: [".c9"],
    c_cpp: [".c", ".cpp"],
    cirru: [".cirru"],
    clojure: [".clj"],
    cobol: [".cob"],
    coffee: [".coffee"],
    coldfusion: [".cfm"],
    csharp: [".cs"],
    css: [".css"],
    curly: [".curl"],
    d: [".d"],
    dart: [".dart"],
    diff: [".diff", ".patch"],
    dockerfile: ["Dockerfile"],
    dot: [".dot"],
    dummy: [".dummy"],
    dummysyntax: [".dummysyntax"],
    eiffel: [".e"],
    ejs: [".ejs"],
    elixir: [".ex", ".exs"],
    elm: [".elm"],
    erlang: [".erl", ".hrl"],
    forth: [".fs", ".fth"],
    ftl: [".ftl"],
    gcode: [".gcode"],
    gherkin: [".feature"],
    gitignore: [".gitignore"],
    glsl: [".glsl"],
    golang: [".go"],
    groovy: [".groovy"],
    haml: [".haml"],
    handlebars: [".hbs", ".handlebars"],
    haskell: [".hs"],
    haxe: [".hx"],
    html: [".html", ".htm"],
    html_ruby: [".html.erb"],
    ini: [".ini"],
    io: [".io"],
    jack: [".jack"],
    jade: [".jade"],
    java: [".java"],
    javascript: [".js"],
    json: [".json"],
    jsoniq: [".jsoniq"],
    jsp: [".jsp"],
    jsx: [".jsx"],
    julia: [".jl"],
    latex: [".tex"],
    less: [".less"],
    liquid: [".liquid"],
    lisp: [".lisp", ".lsp"],
    livescript: [".ls"],
    logiql: [".logic"],
    lsl: [".lsl"],
    lua: [".lua"],
    luapage: [".lp"],
    lucene: [".lucene"],
    makefile: ["Makefile"],
    markdown: [".md", ".markdown"],
    mask: [".mask"],
    matlab: [".m"],
    mel: [".mel"],
    mushcode: [".mc"],
    mysql: [".sql"],
    nix: [".nix"],
    objectivec: [".m", ".h"],
    ocaml: [".ml", ".mli"],
    pascal: [".pas"],
    perl: [".pl", ".pm"],
    pgsql: [".pgsql"],
    php: [".php"],
    powershell: [".ps1"],
    praat: [".praat"],
    prolog: [".pl"],
    properties: [".properties"],
    protobuf: [".proto"],
    python: [".py"],
    r: [".r"],
    rdoc: [".rdoc"],
    rhtml: [".rhtml"],
    ruby: [".rb"],
    rust: [".rs"],
    sass: [".sass", ".scss"],
    scad: [".scad"],
    scala: [".scala"],
    scheme: [".scm"],
    scss: [".scss"],
    sh: [".sh"],
    sjs: [".sjs"],
    smarty: [".tpl"],
    snippets: [".sublime-snippet"],
    soy_template: [".soy"],
    space: [".space"],
    sql: [".sql"],
    stylus: [".styl"],
    svg: [".svg"],
    tcl: [".tcl"],
    tex: [".tex"],
    text: [".txt"],
    textile: [".textile"],
    toml: [".toml"],
    twig: [".twig"],
    typescript: [".ts"],
    vala: [".vala"],
    vbscript: [".vbs"],
    velocity: [".vm"],
    verilog: [".v"],
    vhdl: [".vhd"],
    xml: [".xml"],
    xquery: [".xq", ".xquery"],
    yaml: [".yaml", ".yml"],
    htvm: [".ht", ".hti", ".htpy", ".hth", ".htvm"]
  };

  // Get the extension with dot
  const dotExt = extension.startsWith('.') ? extension : '.' + extension;
  
  // Normalize the extension to lower case
  const normalizedExt = dotExt.toLowerCase();

  // Loop through the mapping to find the language
  for (const [lang, exts] of Object.entries(extToLangMap)) {
    if (exts.includes(normalizedExt)) {
      return lang; // Return the language if a match is found
    }
  }

  return "text"; // Return text if not found (better default than "ht")
}

// Modify the navigateInto function to use the new language mapping
function navigateInto(item) {
  if (!item.isFolder) {
    if (openFile && openFile !== item) {
      openFile.content = editor.getValue();
    }
    openFile = item;
    editor.setValue(item.content || "", -1);
    
    // Get file extension and set appropriate mode
    const extension = item.name.split('.').pop();
    const langMode = fileExtensionToLangName('.' + extension);
    editor.session.setMode("ace/mode/" + langMode);
    
    document.getElementById('editor').style.display = 'block';
    closeIframe();
    let path = findPath(root, item);
    if (path) saveLastFile(path);
    updateFilePathDisplay();
    return;
  }
  if (openFile) {
    openFile.content = editor.getValue();
  }
  dirHistory.push(currentDir);
  currentDir = item;
  document.getElementById('back-btn').disabled = false;
  renderDirectory();
}
    
    function goBack() {
      if (dirHistory.length === 0) return;
      if (openFile) openFile.content = editor.getValue();
      currentDir = dirHistory.pop();
      document.getElementById('back-btn').disabled = dirHistory.length === 0;
      renderDirectory();
    }
    function renderDirectory() {
      const container = document.getElementById('directory-contents');
      container.innerHTML = '';
      currentDir.children.forEach(item => {
        const div = document.createElement('div');
        div.className = `item ${item.isFolder ? 'folder' : 'file'}`;
        const nameSpan = document.createElement('span');
        nameSpan.className = 'name';
        nameSpan.textContent = item.name;
        nameSpan.onclick = () => navigateInto(item);
        div.appendChild(nameSpan);
        const renameBtn = document.createElement('button');
        renameBtn.textContent = '‚úèÔ∏è';
        renameBtn.title = 'Rename';
        renameBtn.className = 'action-btn';
        renameBtn.onclick = (e) => { e.stopPropagation(); renameItem(item); };
        div.appendChild(renameBtn);
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'üóëÔ∏è';
        deleteBtn.title = 'Delete';
        deleteBtn.className = 'action-btn';
        deleteBtn.onclick = (e) => { e.stopPropagation(); deleteItem(item); };
        div.appendChild(deleteBtn);
        container.appendChild(div);
      });
      document.getElementById('path-display').textContent =
        getFullPath(currentDir).join(' / ');
    }
    function getFullPath(dir) {
      let path = [];
      function traverse(node, target, acc) {
        if (node === target) return true;
        if (node.isFolder && node.children) {
          for (let child of node.children) {
            if (traverse(child, target, acc)) {
              acc.unshift(child.name);
              return true;
            }
          }
        }
        return false;
      }
      traverse(root, dir, path);
      return ['root', ...path];
    }
    function updateFilePathDisplay() {
      const display = document.getElementById('file-path-display');
      if (openFile) {
        let fullPath = findPath(root, openFile);
        display.textContent = "Editing: " + fullPath.join(' / ');
      } else {
        display.textContent = "";
      }
    }


function fileMakeOrOverride(name, content = "[empty file]") {
  // Check if the file already exists in the current directory
  let existingFile = currentDir.children.find(item => item.name === name && !item.isFolder);

  if (existingFile) {
    // If the file exists, override its content
    existingFile.content = content;
    //alert(`File "${name}" has been updated.`);
  } else {
    // If the file doesn't exist, create a new file
    let newFile = { name, isFolder: false, content };
    currentDir.children.push(newFile);
    //alert(`File "${name}" has been created.`);
  }

  // Save the file system and re-render the directory
  saveFileSystem();
  renderDirectory();
}

    /* ----------------------------
       Console
    ----------------------------- */

    function logToConsole(message) {
      const logDiv = document.getElementById("console-log");
      logDiv.innerHTML += message + "<br>";
    }



    /* ----------------------------
       HTVM
    ----------------------------- */

function runHTVM(fileContents, fileName) {
    // Get the URL id parameter
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id') || 'default_id'; // Use 'default_id' if 'id' is not in the URL

    // Build the localStorage key based on the id
    const storageKey = `htvm-lang_${id}`;

    // Fetch the stored data from localStorage
    let storedData = localStorage.getItem(storageKey);

    // If there's no stored data, fetch it from the GitHub file
    if (!storedData) {
        fetch('https://raw.githubusercontent.com/TheMaster1127/HTVM/refs/heads/main/HTVM-instructions.txt')
            .then(response => response.text())
            .then(data => {
                // Split the data into lines
                const lines = data.split('\n');
                // Get the first 162 lines
                const first162Lines = lines.slice(0, 162);

                // Store the array in localStorage
                localStorage.setItem(storageKey, JSON.stringify(first162Lines));
                console.log(`First 162 lines have been stored in localStorage as "${storageKey}".`);

                // Call the function again with the fetched data
                runHTVM(fileContents, fileName);
            })
            .catch(error => console.error('Error fetching the file:', error));
    } else {
        // If stored data exists, parse it
        storedData = JSON.parse(storedData);

        // Convert the array of lines into a single string with newlines
        const linesString = storedData.join('\n');

        // Concatenate everything into htvm_instr with a newline between the two parts
        const htvm_instr = linesString + '\n' + (build_in_funcs || '');

        // Now you have the full instruction string in htvm_instr
        let OUTCODE = compiler(fileContents, htvm_instr, "full", "js");
        console.log(fileName);

        // Replace the extension with '.js'
        fileName = fileName.replace(/\.[^/.]+$/, ".js");

        // Call fileMakeOrOverride to save the output
        fileMakeOrOverride(fileName, OUTCODE);
        
        logToConsole("Saved the HTVM output to: " + fileName + " at: " + new Date().toISOString().slice(11, 23));

        if (runJsAfterHTVM) {
            const consoleDiv = document.getElementById("console-log");
            consoleDiv.innerHTML = ""; // Clear previous logs
            closeIframe(); // Close the iframe if applicable

            logToConsole("Running HTVM output...");
            logToConsole("\n");

            // Redirect console.log to also log in the browser
            const originalLog = console.log;
            console.log = function(...args) {
                originalLog.apply(console, args);
                consoleDiv.innerHTML += args.join(" ") + "<br>";
            };

            try {
                new Function(OUTCODE)(); // Execute the generated JS code
            } catch (e) {
                console.log("Error: " + e.message);
            }

            // Restore console.log after running the code
            setTimeout(() => { console.log = originalLog; }, 1000);
        }
    }
}


    /* ----------------------------
       Run File Functionality
    ----------------------------- */
    function runFile() {
      if (!openFile) {
        alert("No file open to run!");
        return;
      }
      const filename = openFile.name;
      const consoleDiv = document.getElementById("console-log");
      consoleDiv.innerHTML = "";
      closeIframe();
      if (filename.endsWith(".js")) {
        const originalLog = console.log;
        console.log = function(...args) {
          originalLog.apply(console, args);
          consoleDiv.innerHTML += args.join(" ") + "<br>";
        };
        try {
          new Function(openFile.content)();
        } catch (e) {
          console.log("Error: " + e.message);
        }
        setTimeout(() => { console.log = originalLog; }, 1000);
      }
      else if (filename.endsWith(".htvm")) {
        //console.log("themaster1127 will make and call a func here to handle .htvm files!!!");
        runHTVM(openFile.content, filename);
      }
      else if (filename.endsWith(".html")) {
        document.getElementById("output-container").style.display = "flex";
        document.getElementById("vertical-splitter").style.display = "block";
        const iframe = document.createElement("iframe");
        iframe.id = "html-output";
        iframe.srcdoc = openFile.content;
        const outputContainer = document.getElementById("output-container");
        outputContainer.insertBefore(iframe, outputContainer.firstChild);
      }
      else {
        alert("File type not supported for execution.");
      }
    }
    function closeIframe() {
      document.getElementById("output-container").style.display = "none";
      document.getElementById("vertical-splitter").style.display = "none";
      document.getElementById("output-container").innerHTML = "";

    }

    /* ----------------------------
       Clear Console Functionality
    ----------------------------- */
    function clearConsole() {
      document.getElementById("console-log").innerHTML = "";
    }

    /* ----------------------------
       Resizable Splitters
    ----------------------------- */
    // Sidebar splitter
    const sidebarSplitter = document.getElementById("sidebar-splitter");
    sidebarSplitter.addEventListener("mousedown", initSidebarResize);
    function initSidebarResize(e) {
      window.addEventListener("mousemove", resizeSidebar);
      window.addEventListener("mouseup", stopSidebarResize);
    }
    function resizeSidebar(e) {
      let newWidth = e.clientX;
      if (newWidth < 150) newWidth = 150;
      if (newWidth > 400) newWidth = 400;
      document.getElementById("sidebar").style.width = newWidth + "px";
    }
    function stopSidebarResize(e) {
      window.removeEventListener("mousemove", resizeSidebar);
      window.removeEventListener("mouseup", stopSidebarResize);
    }
    // Horizontal splitter within IDE (between editor and console)
    const ideHorizontalSplitter = document.getElementById("ide-horizontal-splitter");
    ideHorizontalSplitter.addEventListener("mousedown", initIdeHorizontalResize);
    function initIdeHorizontalResize(e) {
      window.addEventListener("mousemove", resizeIdeHorizontal);
      window.addEventListener("mouseup", stopIdeHorizontalResize);
    }
    function resizeIdeHorizontal(e) {
      const ideRect = document.getElementById("ide-container").getBoundingClientRect();
      let offset = e.clientY - ideRect.top - document.getElementById("buttons-container").offsetHeight;
      if (offset < 50) offset = 50;
      if (offset > ideRect.height - 50) offset = ideRect.height - 50;
      document.getElementById("editor").style.height = offset + "px";
    }
    function stopIdeHorizontalResize(e) {
      window.removeEventListener("mousemove", resizeIdeHorizontal);
      window.removeEventListener("mouseup", stopIdeHorizontalResize);
    }
    // Vertical splitter between IDE and Output
    const verticalSplitter = document.getElementById("vertical-splitter");
    verticalSplitter.addEventListener("mousedown", initVerticalResize);
    function initVerticalResize(e) {
      window.addEventListener("mousemove", resizeVertical);
      window.addEventListener("mouseup", stopVerticalResize);
    }
    function resizeVertical(e) {
      const mainRect = document.getElementById("main-content").getBoundingClientRect();
      let offset = e.clientX - mainRect.left;
      if (offset < 100) offset = 100;
      if (offset > mainRect.width - 100) offset = mainRect.width - 100;
      document.getElementById("ide-container").style.width = offset + "px";
    }
    function stopVerticalResize(e) {
      window.removeEventListener("mousemove", resizeVertical);
      window.removeEventListener("mouseup", stopVerticalResize);
    }

    /* ----------------------------
       Initialization & Keyboard Shortcut
    ----------------------------- */
    renderDirectory();
    const lastFilePath = loadLastFile();
    if (lastFilePath) {
      const pathWithoutRoot = lastFilePath[0] === 'root' ? lastFilePath.slice(1) : lastFilePath;
      const file = getItemByPath(pathWithoutRoot, root);
      if (file && !file.isFolder) {
        openFile = file;
        editor.setValue(file.content || "", -1);
        document.getElementById('editor').style.display = 'block';
        updateFilePathDisplay();
      }
    }
    document.addEventListener("keydown", function(e) {
      if (e.ctrlKey && e.key === "Enter") {
        e.preventDefault();
        runFile();
      }
    });
    
    
// Get the current file path from the file-path-display element
const filePath = document.getElementById('file-path-display').textContent.trim(); // Trim any extra spaces

// Extract the file name from the path
const fileName = filePath.split('/').pop().trim(); // Trim the file name as well

// Find the span element with the file name
const fileNameElement = [...document.querySelectorAll('.item.file .name')]
  .find(span => span.textContent.trim() === fileName); // Trim the text content for comparison

// Simulate a click to open the file
if (fileNameElement) {
    fileNameElement.click();
} else {
    console.log(`File "${fileName}" not found`);
}

// Apply CSS styles for the editor
    
var css = `
    .ace-monokai .ace_marker-layer .ace_active-line {
      background-color: #103010 !important;
    }
    
    .ace-monokai {
      background-color: #050505 !important;
      color: #f8f8f2;
    }
    
    .ace-monokai .ace_gutter {
      background: #204020 !important;
      color: #cbcdc3 !important;
    }
    
    .ace-monokai .ace_gutter-active-line {
      background-color: transparent !important;
    }
    
    .ace-monokai .ace_entity.ace_name.ace_tag,
    .ace-monokai .ace_keyword,
    .ace-monokai .ace_meta.ace_tag,
    .ace-monokai .ace_storage {
      color: #40a0e0 !important;
    }
    
    .ace-monokai .ace_entity.ace_name.ace_function,
    .ace-monokai .ace_entity.ace_other,
    .ace-monokai .ace_entity.ace_other.ace_attribute-name,
    .ace-monokai .ace_variable {
      color: #ff80df !important;
    }
    
    .ace-monokai .ace_comment {
      color: #40d080 !important;
      font-weight: line-through !important;
    }
    
    .ace-monokai .ace_commentOpen_Close {
      color: #40d080 !important;
      font-weight: line-through !important;
    }
    
    .ace-monokai .ace_variables {
      color: #ffffff !important;
    }
    
    .ace-monokai .ace_functions {
      color: #80dfff !important;
    }
    
    .ace-monokai .ace_keywords {
    color: #8080e0 !important; /* Customize color as needed */
    font-weight: bold !important;
    }
    .ace-monokai .ace_braces_Open {
      color: #FFFFff !important;
    }
    
    .ace-monokai .ace_braces_Close {
      color: #FFFFff !important;
    }
    
    .ace-monokai .ace_arrayMethods {
      color: #FAB820 !important;
    }
    
    .ace-monokai .ace_BuildInFunc {
      color: #ff80df !important;
    }
    
    .ace-monokai .ace_command {
      color: #40a0e0 !important;
      font-weight: bold !important;
    }
    
    .ace-monokai .ace_static_types {
      color: #569cd6 !important;
      font-weight: bold !important;
    }
    
    .ace-monokai .ace_string {
      color: #ffa0a0 !important;
      font-weight: lighter !important;
    }
    
    .ace-monokai .ace_operators {
      color: #00ffff !important;
      font-weight: lighter !important;
    }
    
    
    .ace-monokai .ace_trueANDfalse {
      color: #00ffff !important;
      font-weight: lighter !important;
    }
    
    .ace-monokai .ace_escape-char {
      color: #ff8000 !important;
      font-weight: bold !important;
    }
    
    .ace-monokai .ace_punctuation,
    .ace-monokai .ace_punctuation.ace _tag {
      color: #ffa0a0 !important;
    }
    
    *::-webkit-scrollbar {
      width: 1em;
    }
    
    *::-webkit-scrollbar-track {
      box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.3);
    }
    
    *::-webkit-scrollbar-thumb {
      background-color: darkgrey;
      outline: 1px solid slategrey;
    }
`;

var style = document.createElement("style");
style.type = "text/css";
if (style.styleSheet) {
  style.styleSheet.cssText = css;
} else {
  style.appendChild(document.createTextNode(css));
}
document.head.appendChild(style);

let intervalId = setInterval(() => {
    let editor = document.querySelector('.ace_editor.ace_autocomplete.ace-monokai.ace_dark');
    
    if (editor) {
        editor.style.fontSize = '13px'; // Apply the font size change
        clearInterval(intervalId); // Stop the loop after the change
    }
}, 100); // Check every 100ms



  </script>
</body>
</html>

